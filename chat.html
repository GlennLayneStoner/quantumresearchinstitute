<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>QRI Guide</title>
<meta name="color-scheme" content="dark light" />

<style>
  :root{
    --bg:#0b0e12; --panel:#11151b; --panel-2:#151a22;
    --text:#e8eaed; --muted:#a9b3c1; --border:rgba(255,255,255,.08);
    --accent:#00e1ff; --accent-2:#29f0ff;
    --radius:14px; --radius-lg:20px; --radius-xl:24px;
    --shadow:0 12px 36px rgba(0,0,0,.45);
  }

  html,body{
    margin:0;padding:0;
    background: radial-gradient(1200px 1200px at 20% -10%, #0f1730 0%, var(--bg) 55%);
    color:var(--text);
    font:16px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  a{color:var(--accent)}
  .wrap{display:flex;flex-direction:column;min-height:100dvh;padding:8px}

  /* Header */
  header{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    backdrop-filter: blur(10px) saturate(130%);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius-xl);
    box-shadow: 0 10px 40px rgba(0,0,0,.28);
  }
  .bar{padding:10px 12px}
  .bar--stack{display:flex;flex-direction:column;gap:8px}
  .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .title .sep{opacity:.7;margin:0 .25ch}
  .title .sub{font-weight:600;opacity:.9}
  .actions--row{display:flex;gap:8px;flex-wrap:wrap}
  @media (min-width: 720px){ .actions--row{justify-content:flex-end} }

  .btn{
    display:inline-flex;align-items:center;gap:8px;
    background:rgba(255,255,255,.04);color:var(--text);
    border:1px solid rgba(255,255,255,.15);
    border-radius:12px;padding:8px 12px;cursor:pointer
  }
  .btn.secondary{background:rgba(255,255,255,.03)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Chat area */
  .chat{
    flex:1;overflow:auto;scroll-behavior:smooth;
    margin-top:12px;padding:16px;
    background:var(--panel);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius-xl);
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
    display:flex;flex-direction:column
  }

  .msg{display:flex;gap:10px;margin:10px 0}
  .msg .bubble{
    max-width:min(75%, 640px);
    background:var(--panel-2);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius-lg);
    padding:12px 14px;box-shadow:var(--shadow);
    white-space:pre-wrap;word-wrap:break-word;line-height:1.45;font-size:15px
  }
  .msg.assistant .avatar{
    width:28px;height:28px;border-radius:50%;
    background:linear-gradient(135deg,#2bd,#7ff)
  }
  .msg.user{justify-content:flex-end}
  .msg.user .avatar{display:none}
  .msg.user .bubble{
    background:linear-gradient(180deg, var(--accent), var(--accent-2));
    color:#002024;border-color:rgba(0,0,0,.05);
    box-shadow:0 6px 18px rgba(0,225,255,.25)
  }

  /* Assistant contrast boost */
  .msg.assistant .bubble{
    background: rgba(255,255,255,0.10) !important;
    color:#e8eaed !important;
    box-shadow: 0 10px 36px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,225,255,.14);
  }

  .thinking{opacity:.75}

  .code{
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    font-size:.95rem;line-height:1.5;
    background:#0f141b;padding:12px;border-radius:12px;
    border:1px solid rgba(255,255,255,.12);overflow:auto
  }

  /* Composer */
  .composer{
    position:sticky;bottom:0;margin-top:12px;
    background:linear-gradient(180deg, rgba(17,21,27,.92), rgba(17,21,27,.98));
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius-xl);
    padding:10px 10px 8px;
  }
  .row{display:flex;gap:10px;align-items:center}
  textarea{
    flex:1;min-height:50px;max-height:38vh;resize:vertical;
    background:#0f141b;color:var(--text);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;padding:12px 14px;outline:none
  }

  /* Minimal send arrow (no button) */
  .send-arrow{
    font-size:20px; line-height:1;
    color:var(--accent);
    cursor:pointer !important;
    user-select:none;
    margin-left:6px; padding:0 6px;
    display:flex; align-items:center; justify-content:center;
    transition:transform .15s ease, color .15s ease, opacity .15s ease;
  }
  .send-arrow:hover{ transform:scale(1.25); color:#5ffff0; }
  .send-arrow:active{ transform:scale(1.15); opacity:.85; }
  .send-arrow.is-disabled{ opacity:.45; pointer-events:none; }

  /* Hide session count to save space */
  #usage{display:none !important;}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="bar bar--stack">
      <div class="title">Quari <span class="sep">·</span> <span class="sub">the QRI research assistant</span></div>
      <div class="actions actions--row">
        <button class="btn" onclick="location.href='/'" title="Home">Home</button>
        <button id="newBtn" class="btn secondary" title="New session">New</button>
        <button id="exportBtn" class="btn secondary" title="Download as .txt">Export</button>
      </div>
    </div>
  </header>

  <main class="chat" id="chat" aria-live="polite" aria-label="Chat messages"></main>

  <footer class="composer safe-bottom">
    <div class="row">
      <textarea id="input" placeholder="Describe your idea or paste a section of your draft... Ctrl+Enter to send"></textarea>
      <div id="sendBtn" class="send-arrow" role="button" tabindex="0" aria-label="Send">➤</div>
    </div>
    <div class="tools">
      <label class="inline">
        <input type="checkbox" id="escalateBox">
        Escalate 1 turn
      </label>
      <div id="usage" class="badge">0</div>
    </div>
  </footer>
</div>

<script>
/* ---------- config ---------- */
const API_URL = "https://quantumresearchinstitute.vercel.app/api/qri-chat";
const SYSTEM_PROMPT = `You are Quari, the QRI Theory Guide for the **Quantum Research Institute** (QRI).
In this chat, “QRI” ALWAYS means **Quantum Research Institute** (the website you’re on), not any other organization.
If a user mentions or implies “Qualia Research Institute”, briefly note it is a different group and ask if they want to continue with the **Quantum Research Institute** workflow.

Your job: turn an idea into a rigorous plan through four gates:
1) Articulate the thesis in one sentence and define terms.
2) Ground with prior art and at least one falsifiable prediction.
3) Build the minimal model with variables and measurable outputs.
4) Plan an experiment or derivation with controls and failure modes.

Keep answers short, numbered, and end with one actionable next step. Avoid jargon unless asked.`;

/* ---------- state ---------- */
const HISTORY_KEY = "qriHistoryV1";
const MAX_TURNS  = 30;
const STREAMING  = true;

const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const newBtn = document.getElementById('newBtn');
const exportBtn = document.getElementById('exportBtn');
const escalateBox = document.getElementById('escalateBox');

let history = loadHistory();
renderHistory();
scrollToBottom(true); // ensure bottom on initial load

/* ---------- helpers ---------- */
function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    return raw ? JSON.parse(raw) : [{role:"system", content:SYSTEM_PROMPT}];
  }catch{ return [{role:"system", content:SYSTEM_PROMPT}]; }
}
function saveHistory(){
  const trimmed = history.slice(-1 - MAX_TURNS*2);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed));
}
function el(tag, cls, html){ const e=document.createElement(tag); if(cls)e.className=cls; if(html!=null)e.innerHTML=html; return e; }

function sanitize(str){
  return String(str).replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/```([\s\S]*?)```/g, (_,code)=>`<div class="code">${code.replace(/</g,"&lt;")}</div>`);
}

function scrollToBottom(immediate=false){
  const behavior = immediate ? 'auto' : 'smooth';
  // schedule a couple of frames to beat layout timing
  requestAnimationFrame(()=> chatEl.scrollTo({ top: chatEl.scrollHeight, behavior }));
  setTimeout(()=> chatEl.scrollTo({ top: chatEl.scrollHeight, behavior }), 60);
}

function addMessage(role, content){
  const row = el('div', `msg ${role}`);
  const avatar = el('div','avatar');
  const bubble = el('div','bubble');
  bubble.innerHTML = sanitize(content);
  if(role==='assistant'){ row.appendChild(avatar); }
  row.appendChild(bubble);
  chatEl.appendChild(row);
  scrollToBottom();
}

function renderHistory(){
  chatEl.innerHTML = "";
  for(const m of history){
    if(m.role==='system') continue;
    addMessage(m.role, m.content);
  }
  saveHistory();
}

/* ---------- sending ---------- */
async function sendCurrent(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = "";
  addMessage('user', text);
  history.push({role:"user", content:text});
  saveHistory();

  const row = el('div','msg assistant');
  const avatar = el('div','avatar');
  const bubble = el('div','bubble thinking'); bubble.textContent = "Thinking...";
  row.appendChild(avatar); row.appendChild(bubble);
  chatEl.appendChild(row);
  scrollToBottom();

  // faux "disable" for the arrow
  sendBtn.classList.add('is-disabled');
  sendBtn.setAttribute('aria-disabled','true');

  try{
    const body = { messages: history, meta: { escalate: !!escalateBox.checked } };

    const res = await fetch(API_URL, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    const ctype = res.headers.get("Content-Type") || "";
    if(STREAMING && !ctype.includes("application/json") && res.body && "getReader" in res.body){
      bubble.textContent = "";
      let acc = "";
      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");
      while(true){
        const {done, value} = await reader.read();
        if(done) break;
        const chunk = decoder.decode(value, {stream:true});
        const lines = chunk.split(/\r?\n/).filter(Boolean);
        for(const line of lines){
          const m = line.startsWith("data:") ? line.slice(5).trim() : line;
          try{
            const obj = JSON.parse(m);
            const delta = obj.delta ?? obj.content ?? "";
            acc += delta;
            bubble.innerHTML = sanitize(acc);
            scrollToBottom();
          }catch{
            acc += m;
            bubble.innerHTML = sanitize(acc);
            scrollToBottom();
          }
        }
      }
      bubble.classList.remove('thinking');
      history.push({role:"assistant", content:acc});
    }else{
      const data = await res.json();
      bubble.classList.remove('thinking');
      bubble.innerHTML = sanitize(data.content || "");
      history.push({role:"assistant", content:data.content || ""});
      scrollToBottom();
    }
    saveHistory();
  }catch(err){
    bubble.classList.remove('thinking');
    bubble.innerHTML = sanitize("Sorry, I could not reach the QRI server. Please try again in a moment.");
    console.error(err);
  }finally{
    sendBtn.classList.remove('is-disabled');
    sendBtn.removeAttribute('aria-disabled');
  }
}

/* Controls */
sendBtn.addEventListener('click', sendCurrent);
sendBtn.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); sendCurrent(); }
});
inputEl.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ sendCurrent(); }
});
(function(){
  const ta = document.getElementById('input');
  ta.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
      e.preventDefault();
      sendBtn.click();
    }
  });
})();

document.getElementById('newBtn').addEventListener('click', ()=>{
  history = [{role:"system", content:SYSTEM_PROMPT}];
  saveHistory(); renderHistory(); scrollToBottom(true);
});
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const transcript = history.filter(m=>m.role!=="system")
    .map(m=>`${m.role.toUpperCase()}:\n${m.content}\n`).join("\n");
  const blob = new Blob([transcript], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = "qri_session.txt"; a.click();
  URL.revokeObjectURL(url);
});
</script>

<script>
  function trackSend(){
    const i = new Image();
    i.src = "https://c.statcounter.com/13176686/0/1c58bc44/1/?title=" + encodeURIComponent("QRI Chat Send");
  }
  document.title = "QRI Chat Drawer";
</script>

<script type="text/javascript">
  var sc_project=13176686;
  var sc_invisible=1;
  var sc_security="1c58bc44";
  var sc_remove_link=1;
</script>
<script async type="text/javascript" src="https://www.statcounter.com/counter/counter.js"></script>
<noscript>
  <img class="statcounter" src="https://c.statcounter.com/13176686/0/1c58bc44/1/" alt="statcounter">
</noscript>

</body>
</html>
